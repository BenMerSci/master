---
title: "Model 4 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
```
<!-- Load the data --> 
```{r load model4, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model4_ht <- readRDS("../results/model_outputs/output_stan_model4_ht.RDS")
source("../R/10_plot_func.R")
```

# Model 4 hanglind time
## Description of the model
<br>
This fourth model is a new variation. It still compute the mass-action on the numerator, but attempts to make the flux saturate with the part on the denominator with the part of $1 + {...}$, where we use handling time and the whole biomass consumption of the predator.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} = \frac{F_{ij}^{theoretical}}{1+h_ij * \sum_{i=1} ^{i}{F_{j}^{theoretical}}} && F_{ij}^{theoretical} &= \alpha_{j} * B_i * \frac{B_j}{M_j} \\ 
\end{align}

 où <br>
- $\alpha$ est un paramètre spécifique à un prédateur (mais le prédateur peut se retrouver dans plusieurs réseaux différents) <br>
- $B_i$ et $M_i$ sont la biomasse et la bodymass d'une proie dans un réseau spéficique <br>
- $B_j$ et $M_j$ sont la biomasse et la bodymass d'un prédateur spéficique. La biomasse du prédateur est la même dans un réseau, mais peut varier d'un réseau à l'autre, alors que son bodymass sera le même pour chacun des réseaux.<br>

et h_ij est

\begin{align}
h_ij = c \cdot (\frac{Mj}{Mi})^b
\end{align}

```{r structure_data, echo = FALSE, warning=FALSE, message=FALSE}
# Recover types
output_stan_model4_ht <- recover_types(output_stan_model4_ht)
# Draw the posterior for all parameters
general_params <- output_stan_model4_ht |>
                   tidybayes::gather_draws(a_pop, a_sd, c, b, sigma)

a_grp <- output_stan_model4_ht |> tidybayes::gather_draws(a_grp[pred_id]) |>
          dplyr::arrange(pred_id)

# Get pred_id & habitat_type to join with the stan output
pred_ids <- unique(dataset[, c("pred_id", "habitat_type")])
## a_grp
a_grp <- dplyr::left_join(a_grp, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
```

## Summary table
```{r table_4, echo = FALSE}
kable(summary(output_stan_model4_ht, pars = c("a_pop","a_sd","c","b","sigma"))$summary, caption = "Summary table model 4_ht")
```

## Exploring parameters posterior distribution
### Respective predator alphas
```{r alphas-ridgeplots, echo=FALSE, message=FALSE, fig.height=13, fig.width=13}
# Plot the unique alphas by predator
ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators alpha") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 

```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_4_ht <- extract_log_lik(output_stan_model4_ht, merge_chains = FALSE)
r_eff_4_ht <- relative_eff(exp(log_lik_4_ht))
loo_4_ht <- loo(log_lik_4_ht, r_eff = r_eff_4_ht, save_psis = TRUE)
```

```{r wrangling_yrep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
yrep_4_ht <- rstan::extract(output_stan_model4_ht, pars = "y_rep")[[1]]

dataset <- dataset |>
           dplyr::mutate(
            yrep_4_ht_mean = apply(yrep_4_ht, 2, mean)
           )
```

```{r ppc_plots, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}

# Plots for model 4
ppc_plot4_ht <- ppc_loo_pit_overlay(
  y = log(dataset$pred_flow),
  yrep = yrep_4_ht,
  lw = weights(loo_4_ht$psis_object)
) + labs(title = "Model 4_ht")
qq_plot4_ht <- ppc_loo_pit_qq(
  y = log(dataset$pred_flow),
  yrep = yrep_4_ht,
  lw = weights(loo_4_ht$psis_object)
) + labs(title = "Model 4_ht")
```

```{r plot_ppc_qq, echo=FALSE, warning=FALSE, message=FALSE}
ppc_plot4_ht
qq_plot4_ht
```

```{r ppc_dens, echo=FALSE, warning=FALSE, message=FALSE}
bayesplot::ppc_dens_overlay(log(dataset$pred_flow), yrep_4_ht[1:500, ]) + labs(title = "Model 4_ht")
```

## One-one plot of simulation against data
```{r one-one-plot, echo=FALSE, warning=FALSE, message=FALSE}
one_one_plot(dataset, "4_ht") + xlim(c(-13,13)) + ylim(c(-13,13))
```

```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
plot_sim_noerror(output_stan_model4_ht)
plot_sim_error(output_stan_model4_ht)
```