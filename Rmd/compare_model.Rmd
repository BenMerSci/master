---
title: "Compare models"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
```
<!-- Load the data --> 
```{r load_model, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model0 <- readRDS("../results/model_outputs/output_stan_model0.RDS")
output_stan_model1 <- readRDS("../results/model_outputs/output_stan_model1.RDS")
output_stan_model2 <- readRDS("../results/model_outputs/output_stan_model2.RDS")
output_stan_model3 <- readRDS("../results/model_outputs/output_stan_model3.RDS")
output_stan_model4 <- readRDS("../results/model_outputs/output_stan_model4.RDS")
output_stan_model4_ht <- readRDS("../results/model_outputs/output_stan_model4_ht.RDS")

```

```{r r-square-functions, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
table_rsq <- function(list_model) {

        df_list <- purrr::map(list_model, function(x) {
                summary(x)$summary |>
                as.data.frame() |>
                tibble::rownames_to_column(var = "parameters") |>
                dplyr::filter(stringr::str_detect(parameters, "Rsq"))
        })

        df <- do.call(rbind, df_list)

        rsq_table <- knitr::kable(df)

  return(rsq_table)
}

#plot_rsq <- function(list_model) {
#
#        df_list <- purrr::map(list_model, function(x) {
#          as.data.frame(x) |>
#          dplyr::select(dplyr::matches("Rsq"))
#        })
#
#        df <- do.call(cbind, df_list)
#
#        rsq_plot <- bayesplot::mcmc_areas(df, area_method = "equal height") +
#                    ggplot2::xlim(0, 1)
#
#  return(rsq_plot)
#}
```

## R-square
```{r r-squares, echo=FALSE, warning=FALSE, message=FALSE}
list_model <- list(output_stan_model0, output_stan_model1,
                   output_stan_model2, output_stan_model3,
                   output_stan_model4, output_stan_model4_ht)

table_rsq(list_model)
#plot_rsq(list_model)
```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_0 <- extract_log_lik(output_stan_model0, merge_chains = FALSE)
r_eff_0 <- relative_eff(exp(log_lik_0))
loo_0 <- loo(log_lik_0, r_eff = r_eff_0, save_psis = TRUE)

log_lik_1 <- extract_log_lik(output_stan_model1, merge_chains = FALSE)
r_eff_1 <- relative_eff(exp(log_lik_1))
loo_1 <- loo(log_lik_1, r_eff = r_eff_1, save_psis = TRUE)

log_lik_2 <- extract_log_lik(output_stan_model2, merge_chains = FALSE)
r_eff_2 <- relative_eff(exp(log_lik_2))
loo_2 <- loo(log_lik_2, r_eff = r_eff_2, save_psis = TRUE)

log_lik_3 <- extract_log_lik(output_stan_model3, merge_chains = FALSE)
r_eff_3 <- relative_eff(exp(log_lik_3))
loo_3 <- loo(log_lik_3, r_eff = r_eff_3, save_psis = TRUE)

log_lik_4 <- extract_log_lik(output_stan_model4, merge_chains = FALSE)
r_eff_4 <- relative_eff(exp(log_lik_4))
loo_4 <- loo(log_lik_4, r_eff = r_eff_4, save_psis = TRUE)

log_lik_4_ht <- extract_log_lik(output_stan_model4_ht, merge_chains = FALSE)
r_eff_4_ht <- relative_eff(exp(log_lik_4_ht))
loo_4_ht <- loo(log_lik_4_ht, r_eff = r_eff_4_ht, save_psis = TRUE)
```

## Loo-compare the models
```{r compare_loo, echo=FALSE, warning=FALSE, message=FALSE}
loo_compare(list(model_0 = loo_0, model_1 = loo_1, model_2 = loo_2,
            model_3 = loo_3, model_4 = loo_4, model_4_ht = loo_4_ht))
```


```{r compare_alphas, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
a_model2 <- summary(output_stan_model2, pars = "a_grp")$summary[,"mean"]
a_model3 <- summary(output_stan_model3, pars = "a_grp")$summary[,"mean"]
a_model4 <- summary(output_stan_model4, pars = "a_grp")$summary[,"mean"]
a_model4_ht <- summary(output_stan_model4_ht, pars = "a_grp")$summary[,"mean"]
df_alpha <- as.data.frame(cbind(a_model2, a_model3, a_model4, a_model4_ht))
```

```{r plot_alpha, echo=FALSE, warning=FALSE, message=FALSE}
      df_alpha |>
        ggplot(aes(x = a_model2, y = a_model3)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-19,1)) +
        ylim(c(-19,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 2 alphas") +
        ylab("Model 3 alphas") +
        geom_abline(intercept = 0, slope = 1)

      df_alpha |>
        ggplot(aes(x = a_model2, y = a_model4)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-19,1)) +
        ylim(c(-19,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 2 alphas") +
        ylab("Model 4 alphas") +
        geom_abline(intercept = 0, slope = 1)

      df_alpha |>
        ggplot(aes(x = a_model2, y = a_model4_ht)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-19,1)) +
        ylim(c(-19,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 2 alphas") +
        ylab("Model 4_ht alphas") +
        geom_abline(intercept = 0, slope = 1)

      df_alpha |>
        ggplot(aes(x = a_model3, y = a_model4)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-18,1)) +
        ylim(c(-18,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 3 alphas") +
        ylab("Model 4 alphas") +
        geom_abline(intercept = 0, slope = 1)

      df_alpha |>
        ggplot(aes(x = a_model3, y = a_model4_ht)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-18,1)) +
        ylim(c(-18,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 3 alphas") +
        ylab("Model 4_ht alphas") +
        geom_abline(intercept = 0, slope = 1)

      df_alpha |>
        ggplot(aes(x = a_model4, y = a_model4_ht)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        xlim(c(-18,1)) +
        ylim(c(-18,1)) +
        labs(title = "alpha comparisons") +
        xlab("Model 4 alphas") +
        ylab("Model 4_ht alphas") +
        geom_abline(intercept = 0, slope = 1)
```