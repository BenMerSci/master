---
title: "Model 3 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
```
<!-- Load the data --> 
```{r load_model3, echo = FALSE, include = FALSE}
dataset <- readRDS("data/clean/new_dataset.RDS")
output_stan_model3 <- readRDS("results/model_outputs/output_stan_model3.RDS")
source("R/10_plot_func.R")
```

# Model 3
## Description of the model
<br>
This third model is again a slight variant of the two first, in which we assign a specific $\alpha$ to each predator, but we also divide it by the degree of the predator (number of preys). In doing so, we can still isolate difference between predator, to check if some predator seems to be different from the whole, but also try to divide between each of ones predators prey.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} &= \frac{\alpha_{j}}{D_{j}} * B_i * \frac{B_j}{M_j}
\end{align}

This model was fit with a hierarchy implemented on the alpha parameter. A global alpha was estimated, with 118 respective unique alphas for each predators.
In contrast with model 2, the alphas in model 3 are divided by the predator's degree.

```{r structure_data, echo = FALSE, warning=FALSE, message=FALSE}
# Recover types
output_stan_model3 <- recover_types(output_stan_model3)
# Draw the posterior for all parameters
general_params <- output_stan_model3 |>
                   tidybayes::gather_draws(a_pop, a_sd, sigma)

a_grp <- output_stan_model3 |> tidybayes::gather_draws(a_grp[pred_id])

# Get pred_id & habitat_type to join with the stan output
pred_ids <- unique(dataset[, c("pred_id", "habitat_type", "trophic_guild")])

a_grp <-  dplyr::left_join(a_grp, pred_ids, by = "pred_id") |>
          dplyr::mutate(pred_id = as.factor(pred_id),
                        habitat_type = as.factor(habitat_type),
                        trophic_guild = as.factor(trophic_guild))

pred_ids <- pred_ids |> dplyr::mutate(pred_id = as.factor(pred_id),
                                      habitat_type = as.factor(habitat_type),
                                      trophic_guild = as.factor(trophic_guild))
```

## Summary table
```{r table_3, echo = FALSE}
kable(summary(output_stan_model3, pars = c("a_pop","a_sd","sigma"))$summary, caption = "Summary table model 3")
```

### Respective predator alphas
```{r alphas-ridgeplots, echo=FALSE, message=FALSE, fig.height=13, fig.width=13}
# Plot the unique alphas by predator grouped by habitat_type
pred_ids_habitat <- pred_ids |> dplyr::arrange(habitat_type)

ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
    labs(title = "Predators space clearance rate by habitat type (log scale)") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Predators ID") +
       xlab("Space clearance rate") +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) +
       scale_y_discrete(guide = guide_axis(n.dodge = 2), limits = pred_ids_habitat$pred_id)

# Plot the unique alphas by predator grouped by trophic_guild
pred_ids_guild <- pred_ids |> dplyr::arrange(trophic_guild)

ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = trophic_guild)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
    labs(title = "Predators space clearance rate by trophic guilds (log scale)") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Predators ID") +
       xlab("Space clearance rate") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2), limits = pred_ids_guild$pred_id)
```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_3 <- extract_log_lik(output_stan_model3, merge_chains = FALSE)
r_eff_3 <- relative_eff(exp(log_lik_3))
loo_3 <- loo(log_lik_3, r_eff = r_eff_3, save_psis = TRUE)
```

```{r wrangling_yrep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
yrep_3 <- rstan::extract(output_stan_model3, pars = "y_rep")[[1]]

dataset <- dataset |>
           dplyr::mutate(
            yrep_3_mean = apply(yrep_3, 2, mean)
           )
```

```{r ppc_plots, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# Plots for model 3
ppc_plot3 <- ppc_loo_pit_overlay(
  y = log(dataset$pred_flow),
  yrep = yrep_3,
  lw = weights(loo_3$psis_object)
) + labs(title = "Model 3")
qq_plot3 <- ppc_loo_pit_qq(
  y = log(dataset$pred_flow),
  yrep = yrep_3,
  lw = weights(loo_3$psis_object)
) + labs(title = "Model 3")
```

```{r plot_ppc_qq, echo=FALSE, warning=FALSE, message=FALSE}
ppc_plot3
qq_plot3
```

```{r ppc_dens, echo=FALSE, warning=FALSE, message=FALSE}
bayesplot::ppc_dens_overlay(log(dataset$pred_flow), yrep_3[1:500, ]) + labs(title = "Model 3")
```

## One-one plot of simulation against data
```{r one-one-plot, echo=FALSE, warning=FALSE, message=FALSE}
one_one_plot(dataset, 3) + xlim(c(-13,13)) + ylim(c(-13,13))
```

```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
plot_sim_noerror(output_stan_model3)
plot_sim_error(output_stan_model3)
```

# Alphas against predator bodymass
## Check if there is a relation between how big a predator is and its space clearance rate
```r{alpha_mass, echo=FALSE, warning=FALSE, message=FALSE}
alpha_bodymass <- summary(output_stan_model3, pars = "a_grp")$summary |>
                    as.data.frame() |>
                    dplyr::mutate(pred_id = c(1:169)) |>
                    dplyr::select(pred_id, mean) |>
                    dplyr::left_join(dataset, by="pred_id") |>
                    dplyr::select(pred_id, mean, bodymass_mean_predator) |>
                    unique()

alpha_bodymass |>
ggplot(aes(x = log(bodymass_mean_predator), y = mean)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        labs(title = "Relation of space clearance rate and bodymass") +
        xlab("Log bodymass value") +
        ylab("Alpha values") +
        geom_abline(intercept = 0, slope = 1)
```