---
title: "Model 2 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
```
<!-- Load the data --> 
```{r load_model1, echo = FALSE, fig.height=15, fig.width=10}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model2 <- readRDS("../results/model_outputs/output_stan_model2.RDS")
source("../R/10_plot_func.R")
```

# Model 2
## Description of the model
<br>
This second model is a slight variant of the first, in which we assign a specific $\alpha$ to each predator. In doing so, we can isolate difference between predator, to check if some predator seems to be different from the whole.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} &= \alpha_{j} * B_i * \frac{B_j}{M_j}
\end{align}

This model was fit with a hierarchy implemented on the alpha parameter. A global alpha was estimated, with 118 respective unique alphas for each predators.

```{r structure_data, echo = FALSE, warning=FALSE, message=FALSE}
# Recover types
output_stan_model2 <- recover_types(output_stan_model2)
# Draw the posterior for all parameters
general_params <- output_stan_model2 |>
                   tidybayes::gather_draws(a_pop, a_sd, sigma)

a_grp <- output_stan_model2 |> tidybayes::gather_draws(a_grp[pred_id])
         # dplyr::arrange(pred_id)
          #dplyr::mutate(pred_id = as.factor(pred_id))

# Get pred_id & habitat_type to join with the stan output
pred_ids <- unique(dataset[, c("pred_id", "habitat_type")])
a_grp <- dplyr::left_join(a_grp, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
#alphas2_mean <- plyr::ddply(alphas2, "parameters", dplyr::summarise, grp.mean = mean(value))
#other_params2_mean <- plyr::ddply(other_params2, "parameters", dplyr::summarise, grp.mean = mean(value)) |> dplyr::filter(!parameters %in% c("lp__"))
```

## Summary table
```{r table_2, echo = FALSE}
kable(summary(output_stan_model2, pars = c("a_pop","a_sd","sigma"))$summary, caption = "Summary table model 2")
```

## Exploring parameters posterior distribution
### Respective predator alphas
```{r alphas-ridgeplots, echo=FALSE, warning=FALSE, message=FALSE, fig.height=13, fig.width=13}
# Plot the unique alphas by predator
ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators alpha") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 

```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_2 <- extract_log_lik(output_stan_model2, merge_chains = FALSE)
r_eff_2 <- relative_eff(exp(log_lik_2))
loo_2 <- loo(log_lik_2, r_eff = r_eff_2, save_psis = TRUE)
```

```{r wrangling_yrep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
yrep_2 <- rstan::extract(output_stan_model2, pars = "y_rep")[[1]]

dataset <- dataset |>
           dplyr::mutate(
            yrep_2_mean = apply(yrep_2, 2, mean)
           )
```

```{r ppc_plots, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# Plots for model 2
ppc_plot2 <- ppc_loo_pit_overlay(
  y = log(dataset$pred_flow),
  yrep = yrep_2,
  lw = weights(loo_2$psis_object)
) + labs(title = "Model 2")
qq_plot2 <- ppc_loo_pit_qq(
  y = log(dataset$pred_flow),
  yrep = yrep_2,
  lw = weights(loo_2$psis_object)
) + labs(title = "Model 2")
```

```{r plot_ppc_qq, echo=FALSE, warning=FALSE, message=FALSE}
ppc_plot2
qq_plot2
```

```{r ppc_dens, echo=FALSE, warning=FALSE, message=FALSE}
bayesplot::ppc_dens_overlay(log(dataset$pred_flow), yrep_2[1:500, ]) + labs(title = "Model 2")
```


## One-one plot of simulation against data
```{r one-one-plot, echo=FALSE, warning=FALSE, message=FALSE}
one_one_plot(dataset, 2) + xlim(c(-13,13)) + ylim(c(-13,13))
```

```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
plot_sim_noerror(output_stan_model2)
plot_sim_error(output_stan_model2)
```

