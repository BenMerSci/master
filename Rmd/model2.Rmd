---
title: "Model analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(brms))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
# Options to run the chains faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```
<!-- Load the data --> 
```{r load model1, echo = FALSE, include = FALSE}
output_brms_model2 <- readRDS("../results/model_outputs/output_brms_model2.RDS")
output_stan_model2 <- readRDS("../results/model_outputs/output_stan_model2.RDS")
```

# Model 2
## Description of the model
<br>
This second model is a slight variant of the first, in which we assign a specific $\alpha$ to each predator. In doing so, we can isolate difference between predator, to check if some predator seems to be different from the whole.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} &= \alpha_{j} * B_i * \frac{B_j}{M_j}
\end{align}

## Stan section
### Summary table
```{r table_2, echo = FALSE}
kable(summary(output_stan_model2)$summary, caption = "Stan model 2 output")
```

### Traceplots
```{r trace plots, echo = FALSE}
traceplot(output_stan_model2)
```

### Density plots
``` {r density plots, echo = FALSE}
# Structure the outputed data
alphas2 <- rstan::extract(output_stan_model2)["alpha"] |>
            as.data.frame() |>
             pivot_longer(everything()) |>
              dplyr::rename(parameters = "name")

other_params2 <- rstan::extract(output_stan_model2)[c("a_mu","a_sd","sigma","lp__")] |>
                    tibble::enframe() |>
                     tidyr::unnest(cols = "value") |>
                      dplyr::rename(parameters = "name")


alphas2_mean <- plyr::ddply(alphas2, "parameters", summarise, grp.mean = mean(value))
other_params2_mean <- plyr::ddply(other_params2, "parameters", summarise, grp.mean = mean(value)) |>
                       dplyr::filter(!parameters %in% c("lp__"))



alphas2 |>
  ggplot(aes(x = value)) +
   geom_density(color="black", fill="lightblue") +
   facet_grid(parameters ~ .)+
    geom_vline(data = alphas2_mean, aes(xintercept=grp.mean),
     color="black", linetype="dashed", size=1) +
       theme_classic()

other_params2 |>
 dplyr::filter(!parameters %in% c("lp__")) |>
  ggplot(aes(x = value)) +
   geom_density(color="black", fill="lightblue") +
   facet_grid(parameters ~ .)+
    geom_vline(data = other_params2_mean, aes(xintercept=grp.mean),
     color="black", linetype="dashed", size=1) +
       theme_classic()



mcmc_areas(
  output_stan_model2,
  regex_pars = "alpha",
  prob = 0.8, # 80% intervals
  prob_outer = 0.99, # 99%
  point_est = "mean"
)
plot(output_stan_model2, regex_pars = "alpha")
  
```

## Brms section
```{r plotting_2-1, echo = FALSE, out.width = "100%"}
plot(output_brms_model2)
```
