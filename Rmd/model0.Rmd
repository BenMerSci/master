---
title: "Model 0 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
```
<!-- Load the data --> 
```{r load_model1, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model0 <- readRDS("../results/model_outputs/output_stan_model0.RDS")
source("../R/10_plot_func.R")
```

# Model 0
## Description of the model
<br>
Model 0 acts like a null model, where the flux is only fitted to an intercept.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} &= 0
\end{align}

```{r structure_data, echo = FALSE, warning=FALSE, message=FALSE, include=FALSE}
# Recover types
output_stan_model0 <- recover_types(output_stan_model0)
# Draw the posterior for all parameters
general_params <- output_stan_model0 |>
                   tidybayes::gather_draws(Intercept, sigma)
```

## Summary table
```{r table_1, echo = FALSE}
kable(summary(output_stan_model0, pars = c("Intercept","sigma"))$summary, caption = "Summary table model 0")
```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_0 <- extract_log_lik(output_stan_model0, merge_chains = FALSE)
r_eff_0 <- relative_eff(exp(log_lik_0))
loo_0 <- loo(log_lik_0, r_eff = r_eff_0, save_psis = TRUE)
```

## Posterior predictive checks
```{r wrangling_yrep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
yrep_0 <- rstan::extract(output_stan_model0, pars = "y_rep")[[1]]

dataset <- dataset |>
           dplyr::mutate(
            yrep_0_mean = apply(yrep_0, 2, mean)
           )
```

```{r ppc_plots, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# Plots for model 0
ppc_plot0 <- ppc_loo_pit_overlay(
  y = log(dataset$pred_flow),
  yrep = yrep_0,
  lw = weights(loo_0$psis_object)
) + labs(title = "Model 0")
qq_plot0 <- ppc_loo_pit_qq(
  y = log(dataset$pred_flow),
  yrep = yrep_0,
  lw = weights(loo_0$psis_object)
) + labs(title = "Model 0")
```

```{r plot_ppc_qq, echo=FALSE, warning=FALSE, message=FALSE}
ppc_plot0
qq_plot0
```

```{r ppc_dens, echo=FALSE, warning=FALSE, message=FALSE}
bayesplot::ppc_dens_overlay(log(dataset$pred_flow), yrep_0[1:500, ]) + labs(title = "Model 0")
```

## One-one plot of simulation against data
```{r one-one-plot, echo=FALSE, warning=FALSE, message=FALSE}
one_one_plot(dataset, 0) + xlim(c(-10,10)) + ylim(c(-10,10))
```

```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
plot_sim_noerror(output_stan_model0)
plot_sim_error(output_stan_model0)
```