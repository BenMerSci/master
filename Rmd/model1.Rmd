---
title: "Model 1 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
```
<!-- Load the data --> 
```{r load_model1, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model1 <- readRDS("../results/model_outputs/output_stan_model1.RDS")
```

# Model 1
## Description of the model
<br>
Model 1 fits the flux between a prey (i) and its predator (j) only based on mass-action (biomass of prey and abundance of predators).
The scaling parameters $\alpha$ is general to every predator.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} &= \alpha * B_i * \frac{B_j}{M_j}
\end{align}

```{r structure_data, echo = FALSE}
# Recover types
output_stan_model1 <- recover_types(output_stan_model1)
# Draw the posterior for all parameters
general_params <- output_stan_model1 |>
                   tidybayes::gather_draws(a_pop, sigma)
```

## Summary table
```{r table_1, echo = FALSE}
kable(summary(output_stan_model1, pars = c("a_pop","sigma"))$summary, caption = "Summary table model 1")
```

## Exploring parameters posterior distribution
### General parameters
```{r general-ridgeplots, echo=FALSE, message=FALSE, fig.height=10, fig.width=13}
# Plot the global parameters
general_params |>
  ggplot(aes(x = `.value`, y = `.variable`)) +
  geom_density_ridges_gradient(scale = 1, rel_min_height = 0.0001, fill = "lightskyblue3") +
  labs(title = "Posterior distribution of global parameters") +
  theme_ipsum() +
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    plot.title = element_text(size = 30),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15)
  ) +
   xlab("log-values") +
   ylab("Parameter ID")
```

## Traceplots
```{r trace plots, echo = FALSE}
traceplot(output_stan_model1, pars = c("a_pop","sigma"))
```

## Simulated data vs observed data
```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=13}
dataset$sim_pred_flow <- summary(output_stan_model1, pars = "mu")$summary[,"mean"]

dataset |>
  ggplot(aes(x = log(pred_flow), y = sim_pred_flow)) +
  geom_point() +
  labs(title = "Simulated by observed biomass flows (log-scaled)") +
  theme_ipsum() +
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    plot.title = element_text(size = 30),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15)
  ) +
  xlab("Observed biomass flows") +
  ylab("Simulated biomass flows") +
  geom_abline(intercept = 0, slope = 1)
```

