---
title: "Model 4 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(loo))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(patchwork))
```
<!-- Load the data --> 
```{r load model4, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model4 <- readRDS("../results/model_outputs/output_stan_model4.RDS")
source("../R/10_plot_func.R")
```

# Model 4
## Description of the model
<br>
This fourth model is a new variation. It still compute the mass-action on the numerator, but attempts to make the flux saturate with the part on the denominator with the part of $1 + {...}$, where we use handling time and the whole biomass consumption of the predator.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} = \frac{F_{ij}^{theoretical}}{1+h_j * \sum_{i=1} ^{i}{F_{j}^{theoretical}}} && F_{ij}^{theoretical} &= \alpha_{j} * B_i * \frac{B_j}{M_j} \\ 
\end{align}

 où <br>
- $\alpha$ est un paramètre spécifique à un prédateur (mais le prédateur peut se retrouver dans plusieurs réseaux différents) <br>
- $B_i$ est la biomasse de la proie dans un réseau spéficique <br>
- $B_j$ et $M_j$ sont la biomasse et la bodymass d'un prédateur spéficique. La biomasse du prédateur est la même dans un réseau, mais peut varier d'un réseau à l,autre, alors que son bodymass sera le même pour chacun des réseaux.<br>
- $h_j$ est une variable déjà calculée.

```{r structure_data, echo = FALSE, warning=FALSE, message=FALSE}
# Recover types
output_stan_model4 <- recover_types(output_stan_model4)
# Draw the posterior for all parameters
general_params <- output_stan_model4 |>
                   tidybayes::gather_draws(a_pop, a_sd, sigma)

a_grp <- output_stan_model4 |> tidybayes::gather_draws(a_grp[pred_id]) |>
          dplyr::arrange(pred_id)

h_j <- output_stan_model4 |> tidybayes::gather_draws(h_j[pred_id]) |>
         dplyr::arrange(pred_id)

# Get pred_id & habitat_type to join with the stan output
pred_ids <- unique(dataset[, c("pred_id", "habitat_type")])
## a_grp
a_grp <- dplyr::left_join(a_grp, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
## h_j
h_j <- dplyr::left_join(h_j, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
```

## Summary table
```{r table_4, echo = FALSE}
kable(summary(output_stan_model4, pars = c("a_pop","a_sd","sigma"))$summary, caption = "Summary table model 4")
```

## Exploring parameters posterior distribution
### Respective predator alphas
```{r alphas-ridgeplots, echo=FALSE, message=FALSE, fig.height=13, fig.width=13}
# Plot the unique alphas by predator
ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators alpha") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 

```

### Respective predator handling times

```{r handling-ridgeplots, echo=FALSE, message=FALSE, fig.height=13, fig.width=13}
# Plot the unique alphas by predator
ggplot(h_j, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators handling times") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 
```

```{r compute_loo, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, include=FALSE}
log_lik_4 <- extract_log_lik(output_stan_model4, merge_chains = FALSE)
r_eff_4 <- relative_eff(exp(log_lik_4))
loo_4 <- loo(log_lik_4, r_eff = r_eff_4, save_psis = TRUE)
```

```{r wrangling_yrep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
yrep_4 <- rstan::extract(output_stan_model4, pars = "y_rep")[[1]]

dataset <- dataset |>
           dplyr::mutate(
            yrep_4_mean = apply(yrep_4, 2, mean)
           )
```

```{r ppc_plots, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}

# Plots for model 4
ppc_plot4 <- ppc_loo_pit_overlay(
  y = log(dataset$pred_flow),
  yrep = yrep_4,
  lw = weights(loo_4$psis_object)
) + labs(title = "Model 4")
qq_plot4 <- ppc_loo_pit_qq(
  y = log(dataset$pred_flow),
  yrep = yrep_4,
  lw = weights(loo_4$psis_object)
) + labs(title = "Model 4")
```

```{r plot_ppc_qq, echo=FALSE, warning=FALSE, message=FALSE}
ppc_plot4
qq_plot4
```

```{r ppc_dens, echo=FALSE, warning=FALSE, message=FALSE}
bayesplot::ppc_dens_overlay(log(dataset$pred_flow), yrep_4[1:500, ]) + labs(title = "Model 4")
```

## One-one plot of simulation against data
```{r one-one-plot, echo=FALSE, warning=FALSE, message=FALSE}
one_one_plot(dataset, 4) + xlim(c(-13,13)) + ylim(c(-13,13))
```

```{r sim_plot, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=12}
plot_sim_noerror(output_stan_model4)
plot_sim_error(output_stan_model4)
```

# Alphas against predator bodymass
## Check if there is a relation between how big a predator is and its space clearance rate
```r{alpha_mass, echo=FALSE, warning=FALSE, message=FALSE}
alpha_bodymass <- summary(output_stan_model4, pars = "a_grp")$summary |>
                    as.data.frame() |>
                    dplyr::mutate(pred_id = c(1:169)) |>
                    dplyr::select(pred_id, mean) |>
                    dplyr::left_join(dataset, by="pred_id") |>
                    dplyr::select(pred_id, mean, bodymass_mean_predator) |>
                    unique()

alpha_bodymass |>
ggplot(aes(x = log(bodymass_mean_predator), y = mean)) +
        geom_point() +
        theme_minimal() +
        theme(
         legend.title = element_blank(),
         plot.title = element_text(size = 15),
         axis.title.y = element_text(size = 15),
         axis.title.x = element_text(size = 15),
         axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13)
        ) +
        labs(title = "Relation of space clearance rate and bodymass") +
        xlab("Log bodymass value") +
        ylab("Alpha values") +
        geom_abline(intercept = 0, slope = 1)
```