---
title: "Model 4 analysis"
author: "Benjamin Mercier"
date: "`r paste('Last updated on', format(Sys.time(), '%d %B, %Y'))`"
---

<!-- Load nedeed libraries -->
```{r, echo = FALSE, message=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(rstan))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidybayes))
suppressPackageStartupMessages(library(bayesplot))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(ggdist))
suppressPackageStartupMessages(library(ggridges))
suppressPackageStartupMessages(library(hrbrthemes))
suppressPackageStartupMessages(library(viridis))
```
<!-- Load the data --> 
```{r load model4, echo = FALSE, include = FALSE}
dataset <- readRDS("../data/clean/new_dataset.RDS")
output_stan_model4 <- readRDS("../results/model_outputs/output_stan_model4.RDS")
```

# Model 4
## Description of the model
<br>
This fourth model is a new variation. It still compute the mass-action on the numerator, but attempts to make the flux saturate with the part on the denominator with the part of $1 + {...}$, where we use handling time and the whole biomass consumption of the predator.
<!-- Model equation -->
\begin{align}
F_{ij}^{real} = \frac{F_{ij}^{theoretical}}{1+h_j * \sum_{i=1} ^{i}{F_{j}^{theoretical}}} && F_{ij}^{theoretical} &= \alpha_{j} * B_i * \frac{B_j}{M_j} \\ 
\end{align}

 où <br>
- $\alpha$ est un paramètre spécifique à un prédateur (mais le prédateur peut se retrouver dans plusieurs réseaux différents) <br>
- $B_i$ est la biomasse de la proie dans un réseau spéficique <br>
- $B_j$ et $M_j$ sont la biomasse et la bodymass d'un prédateur spéficique. La biomasse du prédateur est la même dans un réseau, mais peut varier d'un réseau à l,autre, alors que son bodymass sera le même pour chacun des réseaux.<br>
- $h_j$ est une variable déjà calculée.

```{r structure_data, echo = FALSE}
# Recover types
output_stan_model4 <- recover_types(output_stan_model4)
# Draw the posterior for all parameters
general_params <- output_stan_model4 |>
                   tidybayes::gather_draws(a_pop, a_sd, sigma)

a_grp <- output_stan_model4 |> tidybayes::gather_draws(a_grp[pred_id]) |>
          dplyr::arrange(pred_id)

h_j <- output_stan_model4 |> tidybayes::gather_draws(h_j[pred_id]) |>
         dplyr::arrange(pred_id)

# Get pred_id & habitat_type to join with the stan output
pred_ids <- unique(dataset[, c("pred_id", "habitat_type")])
## a_grp
a_grp <- dplyr::left_join(a_grp, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
## h_j
h_j <- dplyr::left_join(h_j, pred_ids, by = "pred_id") |>
          dplyr::arrange(pred_id) |>
          dplyr::mutate(pred_id = as.factor(pred_id))
```

## Exploring parameters posterior distribution
### General parameters
```{r general-ridgeplots, echo=FALSE, message=FALSE, fig.height=12, fig.width=10}
# Plot the global parameters
general_params |>
  ggplot(aes(x = `.value`, y = `.variable`)) +
  geom_density_ridges_gradient(scale = 1, rel_min_height = 0.0001, fill = "lightskyblue3") +
  labs(title = "Posterior distribution of global parameters") +
  theme_ipsum() +
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    plot.title = element_text(size = 30),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15)
  ) +
   xlab("log-values") +
   ylab("Parameter ID")
```

### Respective predator alphas
```{r alphas-ridgeplots, echo=FALSE, message=FALSE, fig.height=18, fig.width=15}
# Plot the unique alphas by predator
ggplot(a_grp, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators alpha") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 

```

### Respective predator handling times

```{r handling-ridgeplots, echo=FALSE, message=FALSE, fig.height=18, fig.width=15}
# Plot the unique alphas by predator
ggplot(h_j, aes(x = `.value`, y = pred_id, fill = habitat_type)) +
  geom_density_ridges_gradient(scale = 5, rel_min_height = 0.01) +
   #scale_fill_viridis(option = "C") +
    labs(title = "Posterior distribution of predators handling times") +
     theme_ipsum() +
      theme(
       legend.title = element_text(size = 15),
       legend.text = element_text(size = 13),
       axis.title.y = element_text(size = 20),
       axis.title.x = element_text(size = 20),
       plot.title = element_text(size = 30),
       axis.text.x = element_text(size = 15),
       axis.text.y = element_text(size = 15)
      ) +
       ylab("Parameters ID") +
       xlab("log-values") +
        scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
         scale_fill_manual("Ecosystem type",values = c("terrestrial" = "olivedrab",
          "freshwater" = "sandybrown", "marine" = "deepskyblue3","marine_freshwater" = "slateblue4")) 

```

## Rhats
### Examining Rhats to see if all parameters have converge
```{r rhats, echo=FALSE, message=FALSE}
rhat(output_stan_model4) |>
mcmc_rhat_hist()
```

## Check the fit by plotting the data line
```{r format_data, echo=FALSE, message=FALSE, include=FALSE}
dataset <- dplyr::mutate(dataset, predator_by_web = paste(dataset$predator, dataset$model_name, sep = "_")) |>
           dplyr::mutate(pred_id_by_web = as.numeric(as.factor(predator_by_web)))
dataset <- dataset |>
          dplyr::group_by(pred_id_by_web) |>
            dplyr::summarise(sum_biomass_prey = sum(biomass_prey)) |>
              dplyr::left_join(dataset, by = "pred_id_by_web")
dataset <- dataset |>
               dplyr::mutate(abundance_predator = biomass_predator / bodymass_mean_predator) |>
               dplyr::mutate(h_j = 0.4 * bodymass_mean_predator^-0.75) |>
                dplyr::select(pred_flow, biomass_prey,
                abundance_predator, predator, pred_id,
                h_j, degree_predator, sum_biomass_prey) |>
                dplyr::mutate(pred_id = as.character(pred_id))

df_output_stan <- data.frame(summary(output_stan_model4)$summary) |>
  tibble::rownames_to_column() |>
      dplyr::mutate(test = gsub(".*\\[(.*)\\].*", "\\1", rowname)) |>
        dplyr::rename(parameter = rowname, pred_id = test) |>
          dplyr::select(mean, pred_id) #|>
           # dplyr::mutate(pred_id = as.numeric(pred_id))

dataset <- dataset |> dplyr::mutate(a_pop = df_output_stan[which(df_output_stan$pred_id == "a_pop"),"mean"])
dataset <- dataset |> dplyr::left_join(df_output_stan, by = "pred_id") |>
           dplyr::rename(a_grp_pred = mean) |>
           dplyr::mutate(a_pop = exp(a_pop), a_grp_pred = exp(a_grp_pred)) |>
           dplyr::mutate(alpha_spec = round(a_pop + a_grp_pred, 5))
```

```{r fit-plot, echo=FALSE, message=FALSE, include=FALSE}
#ggplot(dataset, aes(y = pred_flow, x = (((alpha_spec/degree_predator)*biomass_prey*abundance_predator)/(1 + (h_j *(alpha_spec/degree_predator) * abundance_predator * sum_biomass_prey))))) +
#geom_point()
```